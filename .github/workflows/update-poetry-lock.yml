# Update poetry.lock to use poetry version 2.0.0. The original file is generated by Dependabot using 1.8.5. See https://github.com/dependabot/dependabot-core/issues/11237
name: Update Poetry Lock
on:
  workflow_call:     # Allows this workflow to be called from another workflow

jobs:
  update-poetry-lock:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    env:
      POETRY_VERSION: "2.0.0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check Poetry version in lock file
        id: check_poetry_version
        run: |
          if ! grep '@generated by Poetry 2.0.0' poetry.lock; then
            echo "lock_needs_update=true" >> $GITHUB_ENV
          else
            echo "lock_needs_update=false" >> $GITHUB_ENV

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"
          cache: "poetry"

      - name: Install Poetry
        if: env.lock_needs_update == 'true'
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Update Poetry lock file
        if: env.lock_needs_update == 'true'
        run: poetry lock

      - name: Commit and push changes
        if: env.lock_needs_update == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add poetry.lock
          git commit -m "Update poetry.lock using Poetry ${{ env.POETRY_VERSION }}"
          git push
