name: Update Poetry Lock

# 📝 **Description**: Updates poetry.lock files to use Poetry 2.0.0 (workaround for Dependabot's Poetry 1.8.5 limitation)
#
# 🚀 **Triggers**:
#    - Pull requests to main branch
#    - Manual workflow dispatch
#
# 🔧 **Steps**:
#    - 📥 Checkout PR branch with write permissions (abd-vro-machine token)
#    - ✅ Check if poetry.lock was generated by Poetry 2.0.0
#    - 🐍 Install Poetry v2.0.0 and Python v3.12.3 (conditional)
#    - 🔄 Update poetry.lock file using Poetry 2.0.0 (conditional)
#    - ✨ Commit and push updated lock file back to PR branch (conditional)
#
# 📤 **Outputs**:
#    - Updated poetry.lock file using Poetry 2.0.0
#    - Addresses Dependabot limitation (see: https://github.com/dependabot/dependabot-core/issues/11237)
#
# ⚠️ **External Impact**:
#    - Commits directly to pull request branches

on:
  pull_request:
    branches:
      - main

  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write

jobs:
  update-poetry-lock:
    runs-on: ubuntu-latest
    env:
      POETRY_VERSION: "2.0.0"

    steps:
      - name: Check out the PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
          # token with read/write repo access for abd-vro-machine
          token: ${{ secrets.ABD_VRO_MACHINE_READ_WRITE_REPO }}

      - name: Check Poetry version in lock file
        id: check_poetry_version
        run: |
          if ! grep '@generated by Poetry 2.0.0' poetry.lock; then
            echo "Poetry lock file needs to be updated"
            echo "lock_needs_update=true" >> $GITHUB_ENV
          else
            echo "Poetry lock file is up to date"
            echo "lock_needs_update=false" >> $GITHUB_ENV
          fi

      - name: Install Poetry
        if: env.lock_needs_update == 'true'
        run: pipx install poetry==${{ env.POETRY_VERSION }}

      - name: Install Python
        if: env.lock_needs_update == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"
          cache: "poetry"

      - name: Update Poetry lock file
        if: env.lock_needs_update == 'true'
        run: poetry lock

      - name: Commit and push changes
        if: env.lock_needs_update == 'true'
        run: |
          git config user.name "abd-vro-machine"
          git config user.email "${{ secrets.ABD_VRO_MACHINE_EMAIL }}"
          git add poetry.lock
          git commit -m "Update poetry.lock using Poetry ${{ env.POETRY_VERSION }}"
          git push
