# Update poetry.lock generated by Dependabot using 1.8.5: See https://github.com/dependabot/dependabot-core/issues/11237
name: Update Poetry Lock
on:
  workflow_call: # Allows this workflow to be called from another workflow
  workflow_dispatch: # Allow manual triggering

jobs:
  update-poetry-lock:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    env:
      POETRY_VERSION: "2.0.0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check Poetry version in lock file
        id: check_poetry_version
        run: |
          if ! grep '"poetry": "$POETRY_VERSION"' poetry.lock; then
            echo "lock_needs_update=true" >> $GITHUB_ENV
          else
            echo "lock_needs_update=false" >> $GITHUB_ENV

      - name: Set up Python and Poetry
        if: env.lock_needs_update == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install Poetry
        if: env.lock_needs_update == 'true'
        run: pip install poetry==$POETRY_VERSION

      - name: Update Poetry lock file
        if: env.lock_needs_update == 'true'
        run: poetry lock

      - name: Commit and push changes
        if: env.lock_needs_update == 'true'
        run: |
          git add poetry.lock
          git commit -m "Update poetry.lock using Poetry $POETRY_VERSION"
          git push
